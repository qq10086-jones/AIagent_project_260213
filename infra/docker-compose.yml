services:
  redis:
    image: redis:7
    ports: ["6379:6379"]
    networks: ["nexus-net"]

  db:
    image: postgres:16
    environment:
      POSTGRES_USER: nexus
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-nexus}
      POSTGRES_DB: nexus
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks: ["nexus-net"]

  orchestrator:
    build: ../orchestrator
    container_name: nexus-orchestrator
    environment:
      WORKSPACE_ROOT: /workspace
      REDIS_URL: redis://redis:6379
      STREAM_TASK_CODING: stream:task:coding
      PGHOST: db
      PGPORT: 5432
      PGUSER: nexus
      PGPASSWORD: ${POSTGRES_PASSWORD:-nexus}
      PGDATABASE: nexus
      STREAM_TASK: stream:task
      STREAM_RESULT: stream:result
      GROUP_TASK: cg:workers
      GROUP_RESULT: cg:orchestrator
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      QWEN_API_KEY: ${QWEN_API_KEY}
      QWEN_BASE_URL: ${QWEN_BASE_URL}
      QWEN_MODEL: ${QWEN_MODEL:-qwen-plus}
      QUANT_LLM_MODEL: ${QUANT_LLM_MODEL}
      LLM_PROVIDER: ${LLM_PROVIDER:-dashscope}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      DASH_SCOPE_API_KEY: ${DASH_SCOPE_API_KEY}
      AUTO_REPORT_CHANNEL_ID: ${AUTO_REPORT_CHANNEL_ID}
      AUTO_REPORT_TIMEZONE: ${AUTO_REPORT_TIMEZONE:-Asia/Shanghai}
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      APPROVAL_TOKEN: ${APPROVAL_TOKEN:-dev-approval-token}
      CODER_PROVIDER_DEFAULT: ${CODER_PROVIDER_DEFAULT:-opencode}
      CODER_MODEL_DEFAULT: ${CODER_MODEL_DEFAULT:-minimax-m2.5}
    ports:
      - "3000:3000"
    volumes:
      - ../configs/tools.json:/app/configs/tools.json:ro
      - ../orchestrator/src:/app/src
      - ..:/workspace
    depends_on:
      - redis
      - db
      - brain
    networks: ["nexus-net"]

  worker-coder:
    build: ../worker-coder
    container_name: nexus-worker-coder
    environment:
      - REDIS_URL=redis://redis:6379
      - STREAM_TASK=stream:task:coding
      - GROUP_TASK=cg:workers:coding
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CODEX_BIN=${CODEX_BIN:-codex}
      - CODEX_SANDBOX=${CODEX_SANDBOX:-workspace-write}
      - OPENCODE_BIN=${OPENCODE_BIN:-opencode}
      - CODER_PROVIDER_DEFAULT=${CODER_PROVIDER_DEFAULT:-opencode}
      - CODER_MODEL_DEFAULT=${CODER_MODEL_DEFAULT:-minimax-m2.5}
      - PGHOST=db
      - PGPORT=5432
      - PGUSER=nexus
      - PGPASSWORD=${POSTGRES_PASSWORD:-nexus}
      - PGDATABASE=nexus
      - WORKSPACE_ROOT=/workspace
    volumes:
      - ..:/workspace
      - C:/Users/jones/.codex/auth.json:/root/.codex/auth.json:ro
    depends_on:
      - redis
      - db
    networks: ["nexus-net"]

  worker-quant:
    build: ../worker-quant
    container_name: nexus-worker-quant
    environment:
      PYTHONUNBUFFERED: "1"
      PGHOST: db
      PGPORT: 5432
      PGUSER: nexus
      PGPASSWORD: ${POSTGRES_PASSWORD:-nexus}
      PGDATABASE: nexus
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      STREAM_TASK: ${STREAM_TASK:-stream:task}
      STREAM_RESULT: ${STREAM_RESULT:-stream:result}
      STREAM_DLQ: ${STREAM_DLQ:-stream:dlq}
      GROUP: cg:workers
      CONSUMER: worker-quant-1
      OPENCLAW_BASE_URL: http://nexus-openclaw-adapter:18081
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      LLM_PROVIDER: ${LLM_PROVIDER:-ollama}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      DASH_SCOPE_API_KEY: ${DASH_SCOPE_API_KEY}
      QWEN_API_KEY: ${QWEN_API_KEY}
      QWEN_BASE_URL: ${QWEN_BASE_URL}
      QUANT_LLM_MODEL: ${QUANT_LLM_MODEL:-deepseek-r1:1.5b}
      MINIO_ENDPOINT: http://nexus-minio:9000
      MINIO_ACCESS_KEY: nexus
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-nexuspassword}
    volumes:
      - ../configs/tools.json:/app/configs/tools.json:ro
      - ../configs/universe_us.json:/app/configs/universe_us.json:ro
    depends_on:
      - redis
    networks: ["nexus-net"]

  brain:
    build: ../brain
    container_name: brain
    environment:
      - WORKSPACE_ROOT=/workspace
      - PGHOST=db
      - PGPORT=5432
      - PGUSER=nexus
      - PGPASSWORD=${POSTGRES_PASSWORD:-nexus}
      - PGDATABASE=nexus
      - QWEN_API_KEY=${QWEN_API_KEY}
      - QWEN_BASE_URL=${QWEN_BASE_URL}
      - QWEN_MODEL=${QWEN_MODEL:-qwen-plus}
      - ENABLE_BROWSER_FACTS=${ENABLE_BROWSER_FACTS:-auto}
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - QUANT_LLM_MODEL=${QUANT_LLM_MODEL:-deepseek-r1:1.5b}
      - LLM_PROVIDER=${LLM_PROVIDER:-dashscope}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DASH_SCOPE_API_KEY=${DASH_SCOPE_API_KEY}
    ports:
      - "5005:5000"
    volumes:
      - ../brain:/app
      - ..:/workspace
    depends_on:
      - db
    networks: ["nexus-net"]

  openclaw:
    build:
      context: ../openclaw
      dockerfile: Dockerfile
      args:
        OPENCLAW_DOCKER_APT_PACKAGES: "chromium fonts-noto-cjk"
    container_name: nexus-openclaw
    environment:
      OPENCLAW_GATEWAY_PORT: "18789"
      OPENCLAW_GATEWAY_TOKEN: "dev-openclaw-token"
      OPENCLAW_BROWSER_PORT: "18791"
      OLLAMA_BASE_URL: http://host.docker.internal:11434
      OLLAMA_API_KEY: "ollama-local"
      OPENCLAW_CONFIG_PATH: /app/config/openclaw.json
    volumes:
      - ./openclaw.json:/app/config/openclaw.json:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["node","openclaw.mjs","gateway","--allow-unconfigured","--bind","loopback","--port","18789"]
    ports:
      - "18789:18789"
    networks: ["nexus-net"]

  openclaw-adapter:
    build: ./openclaw-adapter
    container_name: nexus-openclaw-adapter
    working_dir: /app
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./openclaw-adapter/server.py:/app/server.py
    environment:
      OPENCLAW_CONTAINER_NAME: nexus-openclaw
      OPENCLAW_BROWSER_PORT: "18791"
      OPENCLAW_GATEWAY_HTTP: "http://nexus-openclaw:18789/"
      MINIO_ENDPOINT: "http://nexus-minio:9000"
      MINIO_ACCESS_KEY: "nexus"
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-nexuspassword}
    ports:
      - "18081:18081"
    depends_on:
      - openclaw
    networks: ["nexus-net"]

  minio:
    image: minio/minio:latest
    container_name: nexus-minio
    environment:
      MINIO_ROOT_USER: nexus
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-nexuspassword}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks: ["nexus-net"]

  minio-init:
    image: minio/mc:latest
    container_name: nexus-minio-init
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://nexus-minio:9000 nexus ${MINIO_SECRET_KEY:-nexuspassword};
      mc mb myminio/nexus-evidence --ignore-existing;
      mc mb myminio/nexus-artifacts --ignore-existing;
      mc mb myminio/nexus-tmp --ignore-existing;
      exit 0;
      "
    networks: ["nexus-net"]

  dashboard:
    image: python:3.11-slim
    container_name: nexus-dashboard
    working_dir: /app
    volumes:
      - ../ui:/app
    environment:
      PYTHONUNBUFFERED: "1"
      STREAMLIT_SERVER_PORT: "8501"
      STREAMLIT_SERVER_HEADLESS: "true"
      MINIO_ENDPOINT: http://nexus-minio:9000
      MINIO_ACCESS_KEY: nexus
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-nexuspassword}
      MINIO_PUBLIC_URL: http://localhost:9000
      QUANT_LLM_MODEL: ${QUANT_LLM_MODEL:-deepseek-r1:32b}
      CODE_LLM_MODEL: ${CODE_LLM_MODEL:-glm-4.7-flash:latest}
      APPROVAL_TOKEN: ${APPROVAL_TOKEN:-dev-approval-token}
    command: >
      sh -c "pip install -r requirements.txt && streamlit run app.py"
    ports:
      - "8501:8501"
    depends_on:
      - db
      - orchestrator
    networks: ["nexus-net"]

networks:
  nexus-net:
    driver: bridge

volumes:
  pgdata:
  minio_data:
