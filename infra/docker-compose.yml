services:
  redis:
    image: redis:7
    ports: ["6379:6379"]

  db:
    image: postgres:16
    environment:
      POSTGRES_USER: nexus
      POSTGRES_PASSWORD: nexus
      POSTGRES_DB: nexus
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  orchestrator:
    build: ../orchestrator
    environment:
      REDIS_URL: redis://redis:6379
      PGHOST: db
      PGPORT: 5432
      PGUSER: nexus
      PGPASSWORD: nexus
      PGDATABASE: nexus
      STREAM_TASK: stream:task
      STREAM_RESULT: stream:result
      GROUP_TASK: cg:workers
      GROUP_RESULT: cg:orchestrator
      VISIBILITY_TIMEOUT_MS: 30000
      RECLAIM_INTERVAL_MS: 5000
      STREAM_DLQ: stream:dlq
      MAX_RECLAIMS: "3"
      HEARTBEAT_INTERVAL_MS: "10000"
      TOOL_REGISTRY_PATH: /app/configs/tools.json
    ports:
      - "3000:3000"
    volumes:
      - ../configs/tools.json:/app/configs/tools.json:ro
      - ../orchestrator/src:/app/src
    depends_on:
      - redis
      - db

  worker-quant:
    build: ../worker-quant
    environment:
      REDIS_URL: redis://redis:6379
      STREAM_TASK: stream:task
      STREAM_RESULT: stream:result
      STREAM_DLQ: stream:dlq
      GROUP: cg:workers
      CONSUMER: worker-quant-1
      MAX_RETRIES: "3"
      HEARTBEAT_INTERVAL_MS: "10000"
      TOOL_REGISTRY_PATH: /app/configs/tools.json
      OPENCLAW_BASE_URL: http://openclaw-adapter:18081
      OLLAMA_BASE_URL: "http://192.168.1.113:11434"
      QUANT_LLM_MODEL: "deepseek-r1:32b"
      CODE_LLM_MODEL: "glm-4.7-flash:latest"
      NEWS_US_UNIVERSE_PATH: "/app/configs/universe_us.json"
      MINIO_ENDPOINT: "http://minio:9000"
      MINIO_ACCESS_KEY: "nexus"
      MINIO_SECRET_KEY: "nexuspassword"
    volumes:
      - ../configs/tools.json:/app/configs/tools.json:ro
      - ../configs/universe_us.json:/app/configs/universe_us.json:ro
    depends_on:
      - redis

  openclaw:
    build:
      context: ../openclaw
      dockerfile: Dockerfile
      # 如果你的 openclaw Dockerfile 支持 build args，这里可以尝试传入（不支持也不影响构建）
      args:
        OPENCLAW_DOCKER_APT_PACKAGES: "chromium fonts-noto-cjk"
    environment:
      OPENCLAW_GATEWAY_PORT: "18789"
      OPENCLAW_GATEWAY_TOKEN: "dev-openclaw-token"

      # ✅ 不再使用 18790（你之前 openclaw-browser 也用的 18790，但那个服务是错误方向）
      #    这里改成常见的派生端口：gateway 18789 -> browser control 18791
      OPENCLAW_BROWSER_PORT: "18791"

      OLLAMA_BASE_URL: "http://192.168.1.113:11434"
      OLLAMA_API_KEY: "ollama-local"
      # 不再死锁单一模型，允许 OpenClaw 识别所有已拉取的 Ollama 模型
      OPENCLAW_CONFIG: '{"agents":{"defaults":{"model":{"primary":"ollama/glm-4.7-flash:latest","fallbacks":["ollama/deepseek-r1:32b"]},"models":{"ollama/glm-4.7-flash:latest":{},"ollama/deepseek-r1:32b":{}}}}}'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["node","openclaw.mjs","gateway","--allow-unconfigured","--bind","lan","--port","18789"]
    ports:
      - "18789:18789"

  openclaw-adapter:
    build:
      context: ./openclaw-adapter
      dockerfile: Dockerfile
    image: infra-openclaw-adapter:dev
    working_dir: /app
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./openclaw-adapter/server.py:/app/server.py
    environment:
      OPENCLAW_CONTAINER_NAME: infra-openclaw-1
      OPENCLAW_BROWSER_PORT: "18791"
      OPENCLAW_GATEWAY_HTTP: "http://openclaw:18789/"
      MINIO_ENDPOINT: "http://minio:9000"
      MINIO_ACCESS_KEY: "nexus"
      MINIO_SECRET_KEY: "nexuspassword"
    ports:
      - "18081:18081"
    depends_on:
      - openclaw

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: nexus
      MINIO_ROOT_PASSWORD: nexuspassword  # 密码最少8位
    ports:
      - "9000:9000" # API 端口
      - "9001:9001" # Web UI 控制台端口
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"

  minio-init:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 nexus nexuspassword;
      mc mb myminio/nexus-evidence --ignore-existing;
      mc mb myminio/nexus-artifacts --ignore-existing;
      mc mb myminio/nexus-tmp --ignore-existing;
      exit 0;
      "

  dashboard:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ../ui:/app
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_HEADLESS=true
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ACCESS_KEY=nexus
      - MINIO_SECRET_KEY=nexuspassword
      - MINIO_PUBLIC_URL=http://localhost:9000
      - QUANT_LLM_MODEL=deepseek-r1:32b
      - CODE_LLM_MODEL=glm-4.7-flash:latest
    command: >
      sh -c "pip install -r requirements.txt && streamlit run app.py"
    ports:
      - "8501:8501"
    depends_on:
      - db
      - orchestrator

volumes:
  pgdata:
  minio_data: # 新增这行
